# Juliaup on HPC

[Juliaup](https://github.com/JuliaLang/juliaup) is the official installer and
version multiplexer for the [Julia language](https://julialang.org/). It is
optimized for managing Julia versions in user directories (which are mostly XDG
compliant) -- and it does an incredible job at that, so we want to make it as
useful for HPC as possible (surely beats `wget`).

## TL;DR: Using Juliaup-HPC

The Julia multiplexing features of Juliaup don't work well on HPC systems.
Juliaup-HPC wraps `juliaup` (see requirements and installation instructions
below) generating module files whenever a new julia version is added by
`juliaup`. This allows Julia version installed by `juliaup-hpc` to be used by
environment module system. All commands are the same as `juliaup`, and
`juliaup-hpc` adds the `--dest` and `--deps` CLI arguments:

```
Usage: juliaup-hpc [--dest <dest>] [-h] <op> [<op_args>] ...
       [--deps [<deps>] ...]
```

1. `--dest`: mandatory argument specifying the `JULIAUP_DEPOT_PATH`, this is
   also the location any module files will be written to (`<dest>/modules`).
2. `--deps`: optional argment listing (comma-delimited) all dependent modules.
   If not specified, this will default to `juliaup`.

### Example:

If you want to install a specific julia version, run:
```
$ module load juliaup
$ juliaup-hpc --dest=/my/local/depot add 1.12
$ module use /my/local/depot
$ ml load julia/1.12
```

## Installing Juliaup-HPC

**Requirements:** Lua >5.2; [Luaposix](https://github.com/luaposix/luaposix)

```
common/juliaup-hpc/
├── dist       # generated by common/juliaup-hpc/src/Makefile
├── sm-config  # recipe for building juliaup
└── src        # juliaup-hpc source code and dependencies
```

The following steps will install Juliaup-HPC:
1. Build `juliaup` without `selfupdate`. If you have a version somewhere, then
   all you need to do it include it in `$PATH`, otherwise, a [Simple
   Modules](https://gitlab.blaschke.science/nersc/simple-modules) setup script
   is included in `common/juliaup-hpc/sm-config` -- to install run:
   `opt/bin/simple-modules.ex --sm-root=<juliaup module location>`. This will
   downloand a rust compiler, build `juliaup`, and gerenate a module file.
2. Add `<install_prefic>/common/juliaup-hpc/dist` to `$PATH`

## Why Juliaup-HPC is needed

Unfortunately the design trade offs that make Juliaup great for small-scale and
single-user environments run into the following problems on large-scale HPC:
1. Juliaup makes assumptions about the file systems to which it is deployed: i)
   that is has write access; ii) that it can set file locks. Both of these
   assumptions break down on many-user shared file systems.
2. Most HPC systems have perfectly good module systems to manage settings and
   versions -- interacting with these is the preferred approach, as it meshes
   better with institutional procedures such as job startup, file system
   optimization, and how shared software is managed (e.g during maintenances).
3. Software that is meant to run at scale shouldn't live in your `$HOME`
   directory (this way HPC deviates from the defaults in the XDG Base Directory
   Specification).

Essentially what works well in HPC is a tool that downloads software to a
specific location (one that can be configured by the user), and bundles it with
the appropriate module file, so that the center's module system can configure
the runtime environment in a way that works well at scale.

## How Juliaup-HPC Helps Deploy a Shared Juliaup Instance on HPC

Juliaup-HPC builds a Juliaup version without the `selfupdate` feature enabled
in cargo, this allows commands like `juliaup add 1.12` to run from read-only
file systems (e.g. shared software installs). We use [Simple
Modules](https://gitlab.blaschke.science/nersc/simple-modules) to bootstrap a
Rust install (using [Rustup](https://rustup.rs/)), so that we can compile
Juliaup.

The rest of Juliaup-HPC is a Lua wrapper script that does two things:
1. It invokes Juliaup with the `JULIAUP_DEPOT_PATH` passed as the `--dest`
   argument (this makes it easier to specify _where_ you want Julia installed).
2. After every time that Juliaup is run, it checks the `JULIAUP_DEPOT_PATH` for
   any newly installed Julia versions, and generates module files which:
    1. set `JULIAUP_DEPOT_PATH` -- this makes it possible to use Juliaup's
       `julia` multiplexer without picking up the "wrong" Juliaup Depot. 
    2. _prepend_ `PATH` -- this is set to point to the location of the `julia`
       binary (not the Julia multiplexer), allowing the user to bypass the
       Juliaup `julia` multiplexer (which can have problems on large-scale
       shared HPC file systems).

## Developing Juliaup-HPC

Please refer to [the developer guide](./src/README.md) for information on how
to develop the `juliaup-hpc` lua wrappers.

## Future Work

In many ways wrapper scripts make HPC unintuitive to use and lead to brittle
workflows (looking at you HPE Cray!), so we will be exploring ways to make
Juliaup support this kind of use case by:
1. [ ] Provide a download script for versions without `selfupdate`
2. [ ] Something like an "HPC mode" which uses
   [Mustache](https://github.com/nickel-org/rust-mustache) to generate
   modulefiles for the system its deployed on.

Crucial is that any of these changes don't break the Juliaup workflow for the
vast majority of users.
